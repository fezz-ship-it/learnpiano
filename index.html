<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pocket Piano Coach ‚Äî Do Re Mi</title>
<style>
  :root {
    --bg:#0b0c10; --panel:#12131a; --muted:#aeb3c2; --fg:#eef1f7; --brand:#6ee7ff; --ok:#38d39f; --warn:#ffb020; --err:#ff5a6e;
    --radius:16px; --pad:16px; --font:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Arial,system-ui;
  }
  html,body { margin:0; padding:0; background:radial-gradient(80vw 50vh at 50% -10%, #1a1d29 0%, #0b0c10 60%); color:var(--fg); font-family:var(--font); }
  .wrap { max-width:720px; margin:0 auto; padding:24px 16px 64px; display:flex; flex-direction:column; gap:16px; }
  header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  h1 { font-size:20px; font-weight:700; margin:0; letter-spacing:0.2px; }
  .btn { appearance:none; border:1px solid #2a2d3a; background:#171925; color:var(--fg); padding:10px 14px; border-radius:999px; font-weight:600; }
  .btn:active { transform:translateY(1px); }
  .seg { display:flex; gap:8px; }
  .seg .chip { border:1px solid #2a2d3a; background:#171925; color:var(--fg); padding:8px 12px; border-radius:999px; font-weight:600; }
  .seg .chip.on { background:var(--brand); color:#091015; border-color:transparent; }
  .card { background:var(--panel); border:1px solid #202333; border-radius:var(--radius); padding:var(--pad); box-shadow:0 6px 24px rgba(0,0,0,.25); }
  .muted { color:var(--muted); font-size:12px; }
  .big { font-size:34px; font-weight:800; letter-spacing:.4px; }
  .status { font-size:16px; margin-top:8px; }
  .ok { color:var(--ok); } .warn{ color:var(--warn); } .err{ color:var(--err); }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  input[type="range"] { width:100%; }
  .toggle { display:flex; align-items:center; gap:8px; }
  .small { font-size:12px; color:var(--muted); }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#181b28; border:1px solid #2a2d3a; }
  svg { width:100%; height:84px; display:block; }
  .kbd { display:grid; grid-template-columns:repeat(14,1fr); gap:6px; margin-top:10px; }
  .key { background:#161826; border:1px solid #262a3a; border-radius:12px; padding:10px 6px; text-align:center; }
  .key:active { transform:translateY(1px); }
  .errbox { display:none; background:#2a1116; border:1px solid #ff5a6e; color:#ffdfe3; border-radius:12px; padding:10px 12px; font-size:13px; }
  .hint { background:#0f1422; border:1px dashed #2a2d3a; border-radius:10px; padding:8px 10px; font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Pocket Piano Coach ‚Äî Do Re Mi Fa Sol La Si Do</h1>
    <button id="startBtn" class="btn" type="button">Start Mic</button>
  </header>

  <div class="seg">
    <button id="modeTrainer" class="chip on" type="button" aria-pressed="true">Note Trainer</button>
    <button id="modeTuner" class="chip" type="button" aria-pressed="false">Tuner</button>
  </div>

  <div id="err" class="errbox"></div>

  <section id="trainerCard" class="card" aria-live="polite">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px;">
      <div>
        <div class="muted">Target</div>
        <div id="targetName" class="big">Do</div>
        <div id="targetInfo" class="small pill">C4 ¬∑ 261.6 Hz ¬∑ treble</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Streak</div>
        <div id="streak" class="big">0</div>
      </div>
    </div>

    <div id="staff" style="margin:10px 0;"></div>

    <div id="status" class="status">Tap <b>Start Mic</b> and allow microphone.</div>
    <div id="centsInfo" class="small"></div>
  </section>

  <section id="tunerCard" class="card" style="display:none">
    <div class="muted">Detected</div>
    <div id="detectedName" class="big">‚Äî</div>
    <div class="small">Use this to check any key or voice pitch.</div>
  </section>

  <section class="card">
    <div class="grid">
      <div>
        <div class="small">Range</div>
        <div class="small" id="rangeLabel">Do (C3) ‚Üí Do (C5)</div>
        <input id="lowRange" type="range" min="36" max="84" step="1" value="52" />
        <input id="highRange" type="range" min="36" max="84" step="1" value="76" />
      </div>
      <div>
        <div class="small">Tolerance (cents)</div>
        <input id="tol" type="range" min="5" max="60" step="1" value="30" />
        <div class="small">¬±<span id="tolVal">30</span>¬¢</div>
        <div class="toggle" style="margin-top:8px;">
          <input id="useSi" type="checkbox" checked />
          <label for="useSi" class="small">Use ‚ÄúSi‚Äù (uncheck for ‚ÄúTi‚Äù)</label>
        </div>
      </div>
    </div>
    <div class="hint" style="margin-top:10px">
      iOS: Settings ‚Üí Safari ‚Üí Microphone ‚Üí Allow. Then reload and tap <b>Start Mic</b>.
    </div>
  </section>

  <section class="card">
    <b>Sight-reading helper</b>
    <p class="small">Target is shown as <b>Do-Re-Mi-Fa-Sol-La-Si-Do</b> (fixed Do) and plotted on a mini staff. Letter names (C, D, E‚Ä¶) show for reference.</p>
    <div class="kbd" id="kbd"></div>
  </section>
</div>

<script>
/* ===== Helpers ===== */
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const SOLF_SI    = ["Do","Do#","Re","Re#","Mi","Fa","Fa#","Sol","Sol#","La","La#","Si"];
const SOLF_TI    = ["Do","Do#","Re","Re#","Mi","Fa","Fa#","Sol","Sol#","La","La#","Ti"];
const $ = id => document.getElementById(id);

function midiToName(m){ const n=NOTE_NAMES[(m%12+12)%12]; const o=Math.floor(m/12)-1; return n+o; }
function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }
function midiToSolfege(m, useSi){ return (useSi? SOLF_SI : SOLF_TI)[(m%12+12)%12]; }
function freqToMidi(f){ return Math.round(69 + 12*Math.log2(f/440)); }
function centsOff(f, ref){ return 1200 * Math.log2(f/ref); }
function randomTarget(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

/* ===== Staff (SVG) ===== */
function drawStaff(container, midi, clef){
  container.innerHTML = "";
  const w = container.clientWidth || 300;
  const h = 84, left=28, right=12, lines=5, sp=h/(lines-1);
  const NS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(NS,"svg"); svg.setAttribute("viewBox",`0 0 ${w} ${h}`);
  for(let i=0;i<lines;i++){ const ln=document.createElementNS(NS,"line");
    ln.setAttribute("x1", left); ln.setAttribute("x2", w-right);
    ln.setAttribute("y1", i*sp); ln.setAttribute("y2", i*sp);
    ln.setAttribute("stroke","#394058"); ln.setAttribute("stroke-width","1"); svg.appendChild(ln);
  }
  const clefText=document.createElementNS(NS,"text");
  clefText.setAttribute("x","6"); clefText.setAttribute("y", sp*(clef==="treble"?1.2:3.8));
  clefText.setAttribute("font-size","20"); clefText.textContent = clef==="treble" ? "ùÑû" : "ùÑ¢";
  svg.appendChild(clefText);

  const ref = clef==="treble" ? 64 : 43; // E4 / G2 bottom line
  const di = m => ({C:0,"C#":0,D:1,"D#":1,E:2,F:3,"F#":3,G:4,"G#":4,A:5,"A#":5,B:6})[NOTE_NAMES[(m%12+12)%12]];
  const steps = (m1,m2)=>{ const o1=Math.floor(m1/12)-1,o2=Math.floor(m2/12)-1; return (o2-o1)*7 + (di(m2)-di(m1)); };
  const k = steps(ref, midi);
  const y = (lines-1)*sp - (k*(sp/2));

  const head=document.createElementNS(NS,"ellipse");
  head.setAttribute("cx","148"); head.setAttribute("cy", y); head.setAttribute("rx","8"); head.setAttribute("ry","6"); head.setAttribute("fill","#e9ecf7");
  svg.appendChild(head);

  const stem=document.createElementNS(NS,"line");
  if (y>sp*2.5) { stem.setAttribute("x1","156"); stem.setAttribute("x2","156"); stem.setAttribute("y1",y); stem.setAttribute("y2",y-sp*3); }
  else { stem.setAttribute("x1","140"); stem.setAttribute("x2","140"); stem.setAttribute("y1",y); stem.setAttribute("y2",y+sp*3); }
  stem.setAttribute("stroke","#e9ecf7"); stem.setAttribute("stroke-width","1.5"); svg.appendChild(stem);

  container.appendChild(svg);
}

/* ===== State ===== */
let ctx=null, analyser=null, stream=null, raf=null, buf=null;
let listening=false, mode="trainer", useSi=true;
let low=52, high=76, threshold=30, target=60, clef="treble", streak=0, okSince=0;
let lastDetected={freq:null,midi:null};

/* ===== Elements ===== */
const els = {
  startBtn: $("startBtn"),
  modeTrainer: $("modeTrainer"),
  modeTuner: $("modeTuner"),
  trainerCard: $("trainerCard"),
  tunerCard: $("tunerCard"),
  targetName: $("targetName"),
  targetInfo: $("targetInfo"),
  streak: $("streak"),
  staff: $("staff"),
  status: $("status"),
  centsInfo: $("centsInfo"),
  detectedName: $("detectedName"),
  lowRange: $("lowRange"),
  highRange: $("highRange"),
  rangeLabel: $("rangeLabel"),
  tol: $("tol"),
  tolVal: $("tolVal"),
  useSi: $("useSi"),
  err: $("err"),
  kbd: $("kbd"),
};

/* ===== UI ===== */
function setMode(next){
  mode=next;
  els.modeTrainer.classList.toggle("on", mode==="trainer");
  els.modeTuner.classList.toggle("on", mode==="tuner");
  els.modeTrainer.setAttribute("aria-pressed", mode==="trainer");
  els.modeTuner.setAttribute("aria-pressed", mode==="tuner");
  els.trainerCard.style.display = mode==="trainer" ? "block" : "none";
  els.tunerCard.style.display   = mode==="tuner"   ? "block" : "none";
  updateUI();
}
function chooseTarget(){
  target = randomTarget(low, high);
  // keep to white keys for now
  while([1,3,6,8,10].includes((target%12+12)%12)) target = randomTarget(low, high);
  clef = target < 60 ? "bass" : "treble";
  updateUI();
}
function updateRangeLabel(){
  els.rangeLabel.textContent = `${midiToSolfege(low,useSi)} (${midiToName(low)}) ‚Üí ${midiToSolfege(high,useSi)} (${midiToName(high)})`;
}
function updateUI(){
  els.targetName.textContent = midiToSolfege(target,useSi);
  els.targetInfo.textContent = `${midiToName(target)} ¬∑ ${midiToFreq(target).toFixed(1)} Hz ¬∑ ${clef}`;
  els.streak.textContent = String(streak);
  drawStaff(els.staff, target, clef);
  if (lastDetected.freq){
    els.detectedName.textContent = `${midiToSolfege(lastDetected.midi,useSi)} ¬∑ ${lastDetected.freq.toFixed(1)} Hz (${midiToName(lastDetected.midi)})`;
  } else {
    els.detectedName.textContent = "‚Äî";
  }
  updateRangeLabel();
  els.tolVal.textContent = String(threshold);
}
function showError(msg){
  els.err.style.display="block";
  els.err.textContent = msg;
}

/* ===== Keyboard (tap practice even if mic fails) ===== */
function buildKbd(){
  els.kbd.innerHTML = "";
  for(let m=48;m<=72;m++){ // C3..C5 whites
    const pc=(m%12+12)%12; if([1,3,6,8,10].includes(pc)) continue;
    const div=document.createElement("button");
    div.type="button";
    div.className="key";
    div.innerHTML = `<div style="font-weight:700">${midiToSolfege(m,useSi)}</div><div class="small">${midiToName(m)}</div>`;
    div.addEventListener("click", ()=> {
      if(m===target){ streak++; els.streak.textContent=String(streak); chooseTarget(); beep(420,120); setTimeout(()=>beep(520,120),130);}
      else { streak=0; els.streak.textContent="0"; beep(180,160); }
    });
    els.kbd.appendChild(div);
  }
}

/* ===== Audio ===== */
async function start(){
  // Clear error
  showError(""); els.err.style.display="none";
  // Permission check
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    showError("Mic not available in this browser. Open the site in Safari/Chrome (HTTPS) and allow microphone.");
    return;
  }
  try{
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    await ctx.resume();
    stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:false } });
    const source = ctx.createMediaStreamSource(stream);
    analyser = ctx.createAnalyser(); analyser.fftSize=2048; analyser.smoothingTimeConstant=0.85;
    source.connect(analyser);
    buf = new Float32Array(analyser.fftSize);
    listening=true; els.startBtn.textContent="Stop"; els.status.textContent="Listening‚Ä¶";
    loop();
  } catch(err){
    showError("Mic error: " + (err.message || String(err)));
    els.status.textContent="Mic blocked."; listening=false;
  }
}
function stop(){
  listening=false; if(raf) cancelAnimationFrame(raf);
  if(stream) stream.getTracks().forEach(t=>t.stop());
  if(ctx) ctx.close();
  ctx=analyser=stream=raf=null;
  els.startBtn.textContent="Start Mic"; els.status.textContent="Stopped.";
}
function detectPitch(buffer, sr){
  const N=buffer.length;
  let rms=0; for(let i=0;i<N;i++) rms+=buffer[i]*buffer[i];
  rms=Math.sqrt(rms/N); if(rms<0.01) return null;
  let mean=0; for(let i=0;i<N;i++) mean+=buffer[i]; mean/=N;
  for(let i=0;i<N;i++) buffer[i]-=mean;

  const MAX=Math.floor(sr/65), MIN=Math.floor(sr/1000);
  let best=-1, bestCorr=0, prev=1;
  for(let off=MIN; off<MAX; off++){
    let c=0; for(let i=0;i<N-off;i++) c+=buffer[i]*buffer[i+off];
    c/=N;
    if(c>0.9 && c>prev && c>bestCorr){ bestCorr=c; best=off; }
    prev=c;
  }
  if(best>0){
    const f=sr/best; if(f>=65 && f<=1000) return f;
  }
  return null;
}
function loop(){
  if(!listening) return;
  analyser.getFloatTimeDomainData(buf);
  const f = detectPitch(buf.slice(), ctx.sampleRate);
  if(f){
    const m = freqToMidi(f); lastDetected={freq:f, midi:m};
    if(mode==="trainer"){
      const diff=centsOff(f, midiToFreq(target));
      els.centsInfo.textContent = `~${Math.round(centsOff(f, midiToFreq(m)))}¬¢ vs nearest`;
      if(Math.abs(diff)<=threshold){
        els.status.innerHTML = `<span class="ok">‚úÖ Hold it‚Ä¶</span>`;
        if(okSince===0) okSince=performance.now();
        if(performance.now()-okSince>550){ streak++; chooseTarget(); okSince=0; }
      } else {
        okSince=0;
        els.status.innerHTML = diff<0 ? `<span class="warn">‚¨ÜÔ∏è Raise a bit</span>` : `<span class="warn">‚¨áÔ∏è Lower a bit</span>`;
      }
    } else {
      els.detectedName.textContent = `${midiToSolfege(m,useSi)} ¬∑ ${f.toFixed(1)} Hz (${midiToName(m)})`;
    }
  } else {
    lastDetected={freq:null,midi:null};
    els.centsInfo.textContent=""; if(mode==="trainer") els.status.textContent="Listening‚Ä¶"; else els.detectedName.textContent="‚Äî";
  }
  raf=requestAnimationFrame(loop);
}
function beep(freq, ms){
  const ac = new (window.AudioContext||window.webkitAudioContext)();
  const o=ac.createOscillator(), g=ac.createGain(); o.type="sine"; o.frequency.value=freq; o.connect(g); g.connect(ac.destination);
  g.gain.setValueAtTime(0.0001, ac.currentTime);
  g.gain.exponentialRampToValueAtTime(0.25, ac.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+ms/1000);
  o.start(); o.stop(ac.currentTime+ms/1000+0.05);
}

/* ===== Events ===== */
els.startBtn.addEventListener("click", function(){ listening ? stop() : start(); }, {passive:true});
els.modeTrainer.addEventListener("click", function(){ setMode("trainer"); }, {passive:true});
els.modeTuner.addEventListener("click", function(){ setMode("tuner"); }, {passive:true});
els.lowRange.addEventListener("input", e=>{ low=+e.target.value; if(low>high) low=high; updateUI(); }, {passive:true});
els.highRange.addEventListener("input", e=>{ high=+e.target.value; if(high<low) high=low; updateUI(); }, {passive:true});
els.tol.addEventListener("input", e=>{ threshold=+e.target.value; updateUI(); }, {passive:true});
els.useSi.addEventListener("change", e=>{ useSi=e.target.checked; buildKbd(); updateUI(); }, {passive:true});

/* ===== Init ===== */
buildKbd();
chooseTarget();
setMode("trainer");
updateUI();
</script>
</body>
</html>

